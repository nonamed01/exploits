// Exercice 5
// Build:
//  gcc -Wl,-z,relro,--build-id=0xdeadbeefcafebabe -no-pie -fno-stack-protector ex5.c -O0 -o ex5
// Goal:    Spawm a shell by calling execve("/bin/sh\x00",NULL,NULL);
//          First thing to achieve is to set RAX to 0x3b. This time, we do not have
//          alarm(), so we need to use  randByte()...
//          There's no syscall gadget.
// Exploit: ex5-exploit.py
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>

char *mydata = "Hello there!";

unsigned char randByte(void);

int main(int argc, char **argv){

    char data[100];
    int mySeed = 0;

    pid_t mypid = getpid();

    // We zero-out data[]:
    memset(&data,0,100);

    // We will use RSP as our seed ;-):
    __asm__("mov %%rsp,%0"
            :"=m"(mySeed)
            :
            :
    );
    srand(mySeed);
    // BOF; returning from main is under our control:
    gets(data);
    
    return 0;
}

// We return only one pseudo-random byte into RAX:
unsigned char randByte(void){
    unsigned char rByte = 0;
    rByte = rand() & 0xff;
    return rByte;
}

__asm__("pop %rdi;ret;");
__asm__("pop %rsi;ret;");
__asm__("pop %rdx;ret;");
