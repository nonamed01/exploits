// Exercice 2
// Build:
//  gcc -Wl,-z,relro,--build-id=0xdeadbeefcafebabe -no-pie -fno-stack-protector ex2.c -o ex2
// Goal:   This binary would be normally solved using ret2dlresolve(), but
//         not this time! The idea is to observe this:
//0x0007ff00   10    127 sym.fgets_unlocked
//0x0007ff90    8    141 sym.fputs_unlocked <- overwritting the last byte 
//                                             in gets_unlocked@got, we can
//                                             transform it into puts_unlocked!
//  So we can overwrite fgets_unlocked and transform it into fputs_unlocked
// Exploit: ex2-exploit.py
#include <stdio.h>
#include <unistd.h>
#include <string.h>

#ifndef fgets_unlocked
    char *fgets_unlocked(char *s, int n, FILE *restrict );
#endif

const char *mydata = "Don't use ret2dlresolve!";
FILE * _fds[2];

int main(int argc, char **argv){

    char data[100];

    // We initialize fds:
    _fds[0] = stdin;
    _fds[1] = stdout;

    // Basic setup to set unbuffered io:
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);

    // We zero-out data[]:
    memset(&data,0,100);
    // BOF; returning from main is under our control:
    fgets_unlocked(data,400,_fds[0]);

    return 0;
}

__asm__("pop %rdi;ret;");
__asm__("pop %rsi;ret;");
__asm__("pop %rdx;ret;");
__asm__("movq -0x18(%rbp), %rsi;ret;");
